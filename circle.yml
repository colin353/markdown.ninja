machine:
  node:
    version: v6.1.0
  services:
    - redis
    - docker

dependencies:
  cache_directories:
    - "app/node_modules"
  override:
    # Install NPM requirements
    - cd app && npm install
    # Install golang dependencies
    - go get -t -d -v ./...
    - go install github.com/golang/lint/golint
test:
  override:
    # Check lint, flow, etc.
    - ./etc/complain.sh
    # Build all the binaries.
    - ./etc/build.sh
    # Build the docker image.
    - docker build --rm=false -t colinmerkel/portfolio:$CIRCLE_SHA1 .
    # Start the docker image on the host.
    - IMAGEPID=`docker run -d --net=host colinmerkel/portfolio:$CIRCLE_SHA1`
    # Presumably we run our integration tests here.
    - echo $IMAGEPID
    # Stop the server. This is necessary because if the server crashed,
    # this will return a nonzero exit code and fail the test.
    - docker stop $IMAGEPID
